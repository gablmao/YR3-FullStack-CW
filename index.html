<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply for After School Classes</title>
    <link rel="stylesheet" href="style.css">
    <!-- Vue integration here -->
    <!--script src="https://unpkg.com/vue"></script-->
    <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
</head>

<body>
    <div id="app">
        <header id="header">
            <h1>After School Classes</h1>
            <!-- Pressing updates HTML to show items added in cart -->
            <button v-on:click="toggleCheckoutPage"> {{ cartItemCount }} View Cart</button>
            <!-- {{}} to display number in vue data -->
        </header>



        <!-- state when IN checkout-->
        <div v-if="showCheckout">
            <h1>Your Cart</h1>

            <div v-if="cart.length == 0">
                <p>Nothing to place order!</p>
            </div>

            <div v-else>
                <div id="product" v-for="product in sortCartById">
                    <!-- pls expand on this -->
                    <!-- <h1>{{ product.id }}</h1> -->
                    <h1>Subject: {{ product.name }}</h1>
                    <img v-bind:src="product.image" height="200"> </img>
                    <p>Place: {{ product.place }}</p>
                    <p>Price: {{ product.price }}</p>
                    <button v-on:click="removeItemFromCart(product)">Remove</button></p>

                </div>
                <h2>Order Details</h2>
                <form @submit.prevent="submitOrder">
                    <!-- v-model affect html inputs, buttons and more. 
                     when inputted, the vue data is updated -->
                    <strong>First Name:</strong>
                    <input type="text" v-model.trim="order.firstName">
                    <strong>Last Name:</strong>
                    <input type="text" v-model.trim="order.lastName">
                    <strong>Phone Number:</strong>
                    <input type="text" v-model.number="order.phone">
                    <p>first name: {{order.firstName}}</p>
                    <p>last name: {{order.lastName}}</p>
                    <p>phone number: {{order.phone}}</p>
                    <button v-if="toggleOrderButton()" disabled> Fill to Order! </button>
                    <button v-else v-on:click="submitOrder">Place Order</button>
                </form>

            </div>
        </div>


        <!-- state when NOT in checkout -->
        <div v-else>
            <div id="sorts">

                <label> Select which to sort:
                    <input type="radio" name="topics" value="name" v-model="selectedTopic" checked>Name
                    <input type="radio" name="topics" value="place" v-model="selectedTopic">Place
                    <input type="radio" name="topics" value="price" v-model="selectedTopic">Price
                    <input type="radio" name="topics" value="slots" v-model="selectedTopic">Slots

                </label>
                <br>
                <label> Select how to sort it:
                    <input type="radio" id="ascending" name="orders" v-model="selectedOrder" value="ascend" checked>
                    Ascending Order
                    <input type="radio" id="descending" name="orders" v-model="selectedOrder" value="descend" checked>
                    Descending Order
                </label>
                <br>
                <button v-on:click="clearFilters">Clear Filters</button>
                <p> Selected filters: {{ testSort }}</p>

            </div>

            <div id="product" v-for="product in sortAscendDescend">

                <h1>Subject: {{ product.name }}</h1>
                <img v-bind:src="product.image" height="200"> </img>
                <p>Place: {{ product.place }}</p>
                <p>Number of Slots left: {{ product.slots }}</p>
                <p>Price: {{ product.price }}</p>
                <button v-if="canBeAddedToCart(product)" v-on:click="addItemToCart(product)">Add to
                    Cart</button>
                <button v-else disabled>Out of Stock!</button>

            </div>


        </div>



        <footer id="footer">
            <p>GM887 2024</p>
        </footer>

    </div>

    <!-- <script src="product.js"></script> -->
    <script>
        let app = new Vue({
            el: '#app',
            data: { //array to store array items
                products: [],
                cart: [], //store items added to cart here
                showCheckout: false, //state to show checkout page
                selectedTopic: "name", //default value
                selectedOrder: "ascend", //default value
                canOrder: false,
                order: { //store order details here
                    firstName: "",
                    lastName: "",
                    phone: "",
                    lessonID: [],
                    spaces: [],
                },
            },
            methods: {
                //add product to cart array and reduce slots by 1
                addItemToCart: function (product) { //product from products array is passed in as an argument
                    this.cart.push(product);
                    product.slots -= 1;
                },

                removeItemFromCart: function (product) {
                    //find in products list, increment by 1, then remove from cart
                    for (let i = 0; this.products.length; i++) {
                        if (this.products[i].id == product.id) {
                            this.products[i].slots += 1;
                            //remove from cart
                            this.cart.pop(product);
                        }
                    }
                },

                toggleCheckoutPage: function () {
                    // toggles showCheckout state to flip between checkout and not checkout
                    this.showCheckout = !this.showCheckout;
                },

                clearFilters: function () {
                    this.selectedTopic = "name";
                    this.selectedOrder = "ascend";
                    //reset products to original list order
                },

                canBeAddedToCart: function (product) {
                    if (product.slots > 0) {
                        return true;
                    } else {
                        return false;
                    }
                },

                toggleOrderButton: function () {
                    if (this.order.firstName == "" || this.order.lastName == "" || this.order.phone == "") {
                        return true;
                    } else {
                        return false;
                    }
                },

                //send order details to mongodb
                submitOrder: function () {
                    let count = 1;
                    let newSlots = [];
                    let newSlotsIndividual = 0;

                    //first step to sort out the lessonIDs and spaces
                    for (let i = 0; i < this.sortCartById.length; i++) {
                        if (this.sortCartById.length == 1) {
                            this.order.lessonID.push(this.sortCartById[i].id);
                            this.order.spaces.push(count);
                            count = 1;
                            break;
                        } else {
                            j = i + 1;
                            for (j; j < this.sortCartById.length; j++) {
                                if (this.sortCartById[j].id == this.sortCartById[i].id) {
                                    count++;
                                } else {
                                    break;
                                }

                            }
                            this.order.lessonID.push(this.sortCartById[i].id);
                            this.order.spaces.push(count);
                            newSlots.push(this.sortCartById[i].slots - count);
                            count = 1;
                            i = j - 1;

                        }

                    }


                    //second step to package the order details ready to send to server
                    const name = (this.order.firstName + " " + this.order.lastName).trim();
                    const fullOrder = {
                        name,
                        phone: this.order.phone,
                        lessonID: this.order.lessonID,
                        spaces: this.order.spaces,
                    };

                    //third step which is to send the order to the server
                    fetch("http://localhost:3000/collections/orders", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(fullOrder),
                    }).then(
                        function (response) {
                            return response.json();
                            alert("Order placed successfully!");
                            //control.log(response.json())
                        }
                    )
                    
                    //fourth step update lesson space after order is placed
                    for (let i of this.order.lessonID){

                    }

                    fetch("http://localhost:3000/collections/lessons/${id}", {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            slots:  newSlotsIndividual,
                        }),
                    })

                    //reset the order details for new order
                    this.firstName = "";
                    this.lastName = "";
                    this.phone = "";
                    this.lessonID = [];
                    this.spaces = [];
                    this.cart = [];

                },
            },
            computed: {
                cartItemCount: function () {
                    return this.cart.length;
                },

                //keep count of how many of the same item is in the cart
                //useful for the lessonID and spaces arrays
                cartCount(id) {
                    let count = 0;
                    for (let i = 0; i < this.cart.length; i++) {
                        if (this.cart[i] === id) {
                            count++;
                        }
                    }
                    return count;
                },

                testSort: function () {
                    let str = this.selectedTopic + " " + this.selectedOrder;
                    return str;

                },

                sortAscendDescend: function () {
                    if (this.selectedOrder == "ascend") {
                        if (this.selectedTopic == "name") {
                            return this.products.sort((a, b) => a.name.localeCompare(b.name));
                        } else if (this.selectedTopic == "place") {
                            return this.products.sort((a, b) => a.name.localeCompare(b.place));
                        } else if (this.selectedTopic == "price") {
                            return this.products.sort((a, b) => a.price - b.price);
                        } else if (this.selectedTopic == "slots") {
                            return this.products.sort((a, b) => a.slots - b.slots);
                        } else {
                            return this.products;
                        }
                    } else if (this.selectedOrder == "descend") {
                        if (this.selectedTopic == "name") {
                            return this.products.sort((a, b) => b.name.localeCompare(a.name));
                        } else if (this.selectedTopic == "place") {
                            return this.products.sort((a, b) => b.name.localeCompare(a.place));
                        } else if (this.selectedTopic == "price") {
                            return this.products.sort((a, b) => b.price - a.price);
                        } else if (this.selectedTopic == "slots") {
                            return this.products.sort((a, b) => b.slots - a.slots);
                        } else {
                            return this.products;
                        };
                    } else {
                        return this.products;
                    }
                },

                sortCartById: function () {
                    return this.cart.sort((a, b) => a.id - b.id);
                },
            },

            created: function () {
                fetch("http://localhost:3000/collections/lessons").then(
                    function (response) {
                        response.json().then(
                            function (json) {
                                app.products = json;
                            }
                        )
                    }
                )
            }
        });
    </script>
</body>

</html>
